{{extend 'layout.html'}}
<style>
.container {
  padding-right: 15px;
  padding-left: 15px;
}

td {
    width: 25%;
    height: 50px;
    padding:0px !important;
    font-family: Helvetica, Arial, Sans-serif;
    font-size: 14px;
}
.course{
    background-color: #64BFFF;
    width: 100%;
    height: 100%;
    display: block;
}
.course div {
    padding:10px;
}
td.highlighted {
    color:black !important;
    border:2px grey dashed !important;
}
.course.math {
    background:#70E899 !important;
}
.course.fe {
    background:#FF9E8E !important;
}
</style>

<script type="text/javascript">
// JSON DATA
var data =
[{"credits": "10", "level": "G1N", "code": "1DT051", "period": "11", "name": "Introduktion till informationsteknologi"},
{"credits": "5", "level": "G1N", "code": "1MA010", "period": "11", "name": "Baskurs i matematik"},
{"credits": "(10)", "level": "G1F", "code": "1DL201", "period": "12", "name": "Programkonstruktion och datastrukturer"},
{"credits": "5", "level": "G1F", "code": "1MA004", "period": "12", "name": "Algebra I"},
{"credits": "(10) 20", "level": "G1F", "code": "1DL201", "period": "13", "name": "Programkonstruktion och datastrukturer"},
{"credits": "(5)", "level": "G1F", "code": "1MA013", "period": "13", "name": "Envariabelanalys"},
{"credits": "10", "level": "G1F", "code": "1DT093", "period": "14", "name": "Datorarkitektur "},
{"credits": "(5) 10", "level": "G1F", "code": "1MA013", "period": "14", "name": "Envariabelanalys"},
{"credits": "(10)", "level": "G1F", "code": "1DL221", "period": "21", "name": "Imperativ och objektorienterad programmeringsmetodik"},
{"credits": "5", "level": "G1F", "code": "1MA025", "period": "21", "name": "Linj\u00e4r algebra och geometri I"},
{"credits": "5", "level": "G1F", "code": "1DL500", "period": "22", "name": "Automater och logik i modellering av IT-system"},
{"credits": "(10) 20", "level": "G1F", "code": "1DL221", "period": "22", "name": "Imperativ och objektorienterad programmeringsmetodik"},
{"credits": "5", "level": "G1F", "code": "1MA024", "period": "23", "name": "Linj\u00e4r algebra II"},
{"credits": "5", "level": "G1F", "code": "1DT044", "period": "23", "name": "Operativsystem I"},
{"credits": "5", "level": "G1F", "code": "1MS005", "period": "24", "name": "Sannolikhet och statistik"},
{"credits": "10", "level": "G1F", "code": "1TE717", "period": "24", "name": "Digitalteknik och elektronik"},
{"credits": "5", "level": "G1F", "code": "1DT052", "period": "31", "name": "Datakommunikation I"},
{"credits": "5", "level": "G1F", "code": "1TD394", "period": "31", "name": "Ber\u00e4kningsvetenskap"},
{"credits": "5", "level": "G1F", "code": "1MA034", "period": "31", "name": "Transformmetoder"},
{"credits": "(5)", "level": "G2F", "code": "1TE682", "period": "32", "name": "Signaler och inbyggda system"},
{"credits": "5", "level": "G1F", "code": "1MA012", "period": "32", "name": "Diskret matematik"},
{"credits": "5", "level": "G1F", "code": "2FE025", "period": "32", "name": "F\u00f6retagsekonomi, baskurs A/B"},
{"credits": "(5)10", "level": "G2F", "code": "1TE682", "period": "33", "name": "Signaler och inbyggda system"},
{"credits": "5", "level": "G1N", "code": "1MD016", "period": "33", "name": "M\u00e4nniska-datorinteraktion"},
{"credits": "5", "level": "G1F", "code": "1DL300", "period": "33", "name": "Databasteknik I"},
{"credits": "15", "level": "G2E", "code": "1DT350", "period": "34", "name": "Sj\u00e4lvst\u00e4ndigt arbete i informationsteknologi"},
{"credits": "5", "level": "G2F", "code": "1DT002", "period": "34.", "name": "Uppsatsmetodik"},
{"credits": "5", "level": "G1F", "code": "1RT155", "period": "34.", "name": "Modellelering av dynamiska system "},
{"credits": "10", "level": "A1N", "code": "1DT092", "period": "34.", "name": "Internationell mjukvaruutveckling, projekt"}];
</script>

<script type="text/javascript">
$( document ).ready(function() {


    /* Helper methods */
    function spwan_row() {
        $td = $("<td>").addClass("td_course");
        $tr = $("<tr>");
        $tr.append($td).append($td.clone()).append($td.clone()).append($td.clone());
        return $tr;
    }

    function course_class(course_code) {
        var typeClass;
        switch(course_code.substring(1,3)) {
            case "MS":
            case "MA":
                typeClass = "math";
                break;
            case "FE":
                typeClass = "fe";
                break;
            default:
                typeClass = "tech";
                break;
        }

        return typeClass;
    }

    /* Populate methods */
    var $studyplans = $(".studyplan");

    manage_data(data);

    $studyplans.each(function(index, studyplan) {
        populate_studyplan($(studyplan), data, index+1);
    });

    function populate_studyplan($studyplan, data, year) {
        var $body = $();
        var data_year = [];
        data.forEach(function (course) {
            var course_year = parseInt(course["period"].substring(0,1));
            if (course_year === year) {
                data_year.push(course);
            }
        });

        var num_rows = find_rows_num(data_year, year);
        var start_period = 1+(year*10);
        for (var i = 0; i < num_rows; i++) {
            var $tr = $("<tr></tr>");
            for (var period = start_period; period <= (start_period+3); period++) {
                var $td = $("<td class='td_course'>");
                $td.data("y", i);
                $td.data("x", $tr.children("td").length);
                var dup;
                for(var j = 0; j < data_year.length; j++) {
                    dup = false;
                    var course = data_year[j];
                    var course_period = parseInt(course["period"]);
                    if (course_period === period) {
                        data_year.splice(j, 1);
                        $td.html("<div class='course'><div>" + course["code"] + " " + course["level"] +" <br>" + course["name"] + "</div></div>");
                        var $course = $td.children(".course");
                        $course.addClass(course_class(course["code"]));

                        if (course.dup){
                            dup = true;
                            $td.children(".course").width("200%");
                            period++;
                        }
                        $course.data(course);
                        break;
                    }
                }
                $tr.append($td);
                if (dup) {
                    $fillTd = $("<td class='td_course'></td>");
                    $fillTd.data("y", i);
                    $fillTd.data("x", $tr.children("td").length);
                    $tr.append($fillTd);
                }
                $studyplan.append($tr);
            }
        }
        $studyplan.append(spwan_row());
    }

    function find_rows_num(data, year) {
        var prev_period = null;
        var max_rows = 0;
        var period_rows = 1;
        data.forEach(function (course) {
            var course_period = parseInt(course["period"].substring(1,2));
            var course_year = parseInt(course["period"].substring(0,1));
            if (year === course_year) {
                if (course_period == prev_period) {
                    period_rows++;
                }
                else {
                    period_rows = 1;
                }
                if (period_rows > max_rows) {
                    max_rows = period_rows;
                }
            }

            prev_period = course_period;
        });
        return max_rows;
    }

    function manage_data(data) {
        data.forEach(function (course){
            var occurrence = 0;
            var course_code = course.code;
            for(var i = 0; i < data.length; i++){
                if(data[i].code == course_code){
                    occurrence++;
                    if(occurrence > 1){
                        course.dup = true;
                        data.splice(i, 1);
                    }
                }
            }
        });
    }

    $(".course").draggable({
        snap: false,
        cursor: "move",
        revert: "invalid"
    });

    $(".course").on("dragstart", function(event, ui) {
        $studyplans.each(function(index, studyplan) {
            //$(studyplan).addClass("table-bordered");
        });
    });
    $(".course").on("dragstop", function(event, ui) {
        $studyplans.each(function (index, studyplan) {
            $tr = spwan_row();
            //$(studyplan).append($tr);
        });
    });

    $(".td_course").droppable({
        accept: ".course",
        hoverClass: "highlighted",
        drop: function(event, ui) {
            $hasDiv = $(this).find("div");
            $element = ui.draggable.css("left", 0).css("top", 0);
            if(!$hasDiv.length)
                $(this).append($element);
            $studyplans.each(function(index, studyplan) {
                //$(studyplan).removeClass("table-bordered");
            });
        }
    });

});

</script>

<div class="container">
    <h1>Studieplan för IT 2013/1014 (år 1-3)</h1>
    <div class="table-responsive">
        <h2>År 1</h2>
        <table class="studyplan table table-bordered">
            <thead>
                <tr>
                    <th>Period 1</th>
                    <th>Period 2</th>
                    <th>Period 3</th>
                    <th>Period 4</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
    <div class="table-responsive">
        <h2>År 2</h2>
        <table class="studyplan table table-bordered">
            <thead>
                <tr>
                    <th>Period 1</th>
                    <th>Period 2</th>
                    <th>Period 3</th>
                    <th>Period 4</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
    <div class="table-responsive">
        <h2>År 3</h2>
        <table class="studyplan table table-bordered">
            <thead>
                <tr>
                    <th>Period 1</th>
                    <th>Period 2</th>
                    <th>Period 3</th>
                    <th>Period 4</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
</div>